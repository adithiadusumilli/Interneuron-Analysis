function plotSignificantCrossCorrsFromFile(matFile)
% plotSignificantCrossCorrsFromFile(matFile)
% Loads pairwise cross-correlation data from a .mat file
% Filters neuron pairs whose peak correlations are > 3 SDs above null distribution
% Plots histograms of peak lag and correlation for only those significant pairs
%
% Inputs:
%   matFile - string path to the .mat file containing:
%       allPeakLags, allPeakCorrs, controlCorrs (3D matrix)
%
% Example:
%   plotSignificantCrossCorrsFromFile('PairwiseCrossCorrelationResults.mat')

% Load required variables
load(matFile, 'allPeakLags', 'allPeakCorrs', 'controlCorrs');

% Initialize output containers
sigLagVec = [];
sigCorrVec = [];
allLagVec = [];
allCorrVec = [];

numSessions = size(allPeakCorrs, 1);
numRegions = size(allPeakCorrs, 2);

% Iterate through sessions and regions
for sess = 1:numSessions
    for reg = 1:numRegions
        peakCorrs = allPeakCorrs{sess, reg};
        peakLags = allPeakLags{sess, reg};

        if isempty(peakCorrs) || isempty(controlCorrs)
            continue;
        end

        % Pull matching 3D null distribution
        nullDist = controlCorrs;

        if ndims(nullDist) ~= 3
            warning('Control correlation matrix is not 3D.');
            continue;
        end

        [numInt, numPyr, ~] = size(nullDist);

        for i = 1:numInt
            for j = 1:numPyr
                nullVals = squeeze(nullDist(i, j, :));
                nullMean = mean(nullVals, 'omitnan');
                nullStd = std(nullVals, 'omitnan');

                actualCorr = peakCorrs(i, j);
                actualLag = peakLags(i, j);

                allCorrVec(end+1) = actualCorr;
                allLagVec(end+1) = actualLag;

                if ~isnan(actualCorr) && actualCorr > (nullMean + 3 * nullStd)
                    sigCorrVec(end+1) = actualCorr;
                    sigLagVec(end+1) = actualLag;
                end
            end
        end
    end
end

% Count
totalPairs = numel(allCorrVec);
sigPairs = numel(sigCorrVec);

% Plot: Peak Lag Histogram
figure;
histogram(sigLagVec, 50, 'FaceAlpha', 0.8, 'EdgeColor', 'none');
xlabel('Peak Lag (sec)');
ylabel('Count');
title(sprintf('Significant Peak Lags (n = %d / %d)', sigPairs, totalPairs));
grid on;

% Plot: Peak Correlation Histogram
figure;
histogram(sigCorrVec, 50, 'FaceAlpha', 0.8, 'EdgeColor', 'none');
xlabel('Peak Correlation');
ylabel('Count');
title(sprintf('Significant Peak Correlations (n = %d / %d)', sigPairs, totalPairs));
grid on;
end
