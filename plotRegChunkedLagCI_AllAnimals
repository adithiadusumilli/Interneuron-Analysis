function plotRegChunkedLagCI_AllAnimals(baseRoot)
% plots cortical chunked XC peak lag permutation distributions
% using the combined Quest output:
%   allAnimals_concatCrossCorr_chunked_perms.mat

% expected variables inside that .mat:
%   allPermPeakLagSec : nAnimals x 1 cell, each 1 x nPerm double
%   allUnpermPeakLag  : nAnimals x 1 cell, each scalar double
%   baseDirs          : 1 x nAnimals cell of char paths
%   nPerm             : scalar (number of permutations)

% inputs:
%   baseRoot (optional): folder containing allAnimals_concatCrossCorr_chunked_perms.mat
%       default: 'C:\Users\mirilab\Documents\GlobusTransfer'

    if nargin < 1 || isempty(baseRoot)
        baseRoot = 'C:\Users\mirilab\Documents\GlobusTransfer';
    end

    matFile = fullfile(baseRoot, 'allAnimals_concatCrossCorr_chunked_perms.mat');
    if ~exist(matFile, 'file')
        error('combined file not found: %s', matFile);
    end

    S = load(matFile, 'allPermPeakLagSec', 'allUnpermPeakLag', 'baseDirs', 'nPerm');

    allPermPeakLagSec = S.allPermPeakLagSec; % cell: {animal}(1 x nPerm)
    allUnpermPeakLag = S.allUnpermPeakLag; % cell: {animal}(1 x 1)
    baseDirs = S.baseDirs; % cell: 1 x nAnimals
    nPerm = S.nPerm; %#ok<NASGU> % not strictly needed, but nice to keep

    nAnimals = numel(baseDirs);

    % derive simple labels from baseDirs (e.g., 'D026')
    animalLabels = cell(1, nAnimals);
    for iA = 1:nAnimals
        [~, animalLabels{iA}] = fileparts(baseDirs{iA});
    end

    % holders for combined summary
    allPermLags   = []; % concatenated permuted lags across animals
    allActualLags = nan(1, nAnimals); % actual lag per animal

    % ---------- per-animal figure ----------
    figure('Name','Cortex chunked XC peak lag permutation distributions (per animal)', ...
           'Color','w');
    tiledlayout(1, nAnimals, 'TileSpacing','compact', 'Padding','compact');

    for iA = 1:nAnimals
        nexttile; hold on;

        label = animalLabels{iA};
        permCell = allPermPeakLagSec{iA};
        unpermCell = allUnpermPeakLag{iA};

        if isempty(permCell) || all(isnan(permCell))
            title(sprintf('%s (no perm data)', label));
            axis off;
            continue;
        end

        permLags = permCell(:)'; % ensure row
        actualLag = unpermCell; % scalar

        validPerm = ~isnan(permLags);
        if ~any(validPerm)
            title(sprintf('%s (no valid perm lags)', label));
            axis off;
            continue;
        end

        permLagsValid = permLags(validPerm);

        % add to combined arrays
        allPermLags = [allPermLags, permLagsValid]; %#ok<AGROW>
        allActualLags(iA) = actualLag;

        % 95% CI for this animal
        lagCI = prctile(permLagsValid, [2.5 97.5]);

        % histogram of permuted lags
        histogram(permLagsValid, 'BinMethod','fd'); hold on;

        % CI lines
        xline(lagCI(1), 'k--', 'LineWidth', 1.5);
        xline(lagCI(2), 'k--', 'LineWidth', 1.5);

        % actual lag
        xline(actualLag, 'r-', 'LineWidth', 2);

        xlabel('peak lag (s)');
        ylabel('count');
        title(label);

        legend({ ...
            'permuted lags', ...
            sprintf('2.5%% = %.3f s', lagCI(1)), ...
            sprintf('97.5%% = %.3f s', lagCI(2)), ...
            sprintf('actual = %.3f s', actualLag)}, ...
            'Location','best');

        grid on; box off;
    end

    % ---------- combined summary plot ----------
    if ~isempty(allPermLags)
        lagCI_all = prctile(allPermLags, [2.5 97.5]);

        figure('Name','Cortex chunked XC peak lag permutations (all animals combined)', ...
               'Color','w');
        histogram(allPermLags, 'BinMethod','fd'); hold on;

        % CI lines
        xline(lagCI_all(1), 'k--', 'LineWidth', 1.5);
        xline(lagCI_all(2), 'k--', 'LineWidth', 1.5);

        % actual lag per animal
        co = lines(nAnimals);
        legEntries = { ...
            'permuted lags', ...
            sprintf('2.5%% (all) = %.3f s', lagCI_all(1)), ...
            sprintf('97.5%% (all) = %.3f s', lagCI_all(2))};

        for iA = 1:nAnimals
            if isnan(allActualLags(iA)), continue; end
            xline(allActualLags(iA), '-', 'Color', co(iA,:), 'LineWidth', 2);
            legEntries{end+1} = sprintf('actual %s = %.3f s', animalLabels{iA}, allActualLags(iA)); %#ok<AGROW>
        end

        xlabel('peak lag (s)');
        ylabel('count');
        title('combined permutation distribution (all animals)');
        legend(legEntries, 'Location','best');
        grid on; box off;
    else
        warning('no valid permuted lags found across animals for combined plot.');
    end

end
