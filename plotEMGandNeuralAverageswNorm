function plotEMGandNeuralAverageswNorm(dataFile, channelsToUse, doBaselineNorm)
% plots mean ± sem traces for emg, cortex-pyr, cortex-int, striatum-pyr, and striatum-int
% data comes from output of extractEMGandNeuralWindows func
% only events originating from the specified emg channels are pooled
%
% inputs:
%   dataFile      : full path to 'emg_neural_allchannels.mat' (or equivalent)
%   channelsToUse : vector with channel indices to pool (default = 1:4)
%   doBaselineNorm: logical, per-trial baseline subtract (-500 to -450 ms)
%                   after avg across neurons but before avg across trials
%                   (default = true)

    if nargin < 2 || isempty(channelsToUse), channelsToUse = 1:4; end
    if nargin < 3 || isempty(doBaselineNorm), doBaselineNorm = true; end

    % add shadedErrorBar (edit path if moved)
    sep = 'c:\github\interneuron-analysis';
    fcn = fullfile(sep,'shadedErrorBar.m');
    if exist(fcn,'file'), addpath(genpath(sep)); end

    % load variables saved by extractEMGandNeuralWindows
    S = load(dataFile, ...
        'emgWindowsCell','pyrCxWinCell','intCxWinCell','pyrStrWinCell','intStrWinCell','tAxis', ...
        'pyrCxWinShiftedCell','intCxWinShiftedCell','pyrStrWinShiftedCell','intStrWinShiftedCell', ...
        'pyrCxWinShiftedMeanCell','intCxWinShiftedMeanCell','pyrStrWinShiftedMeanCell','intStrWinShiftedMeanCell');

    tAxisFull = S.tAxis;   % ms, expected -500..500

    % -------- helper funcs --------
    % avg across neurons -> (events x time)
    meanEvt = @(M) squeeze(mean(M, 2, 'omitnan'));

    % grand mean and sem across events
    grandMS = @(E) deal(mean(E,1,'omitnan'), std(E,0,1,'omitnan')./sqrt(size(E,1)));

    % per-trial baseline subtraction using -500 to -450 ms window
    function Eout = subtractTrialBaseline(Ein, tAxisLocal, tStart, tEnd)
        % ein: events x time
        [~, iStart] = min(abs(tAxisLocal - tStart));
        [~, iEnd]   = min(abs(tAxisLocal - tEnd));
        if iEnd < iStart
            tmp = iStart; iStart = iEnd; iEnd = tmp;
        end
        baselines = mean(Ein(:, iStart:iEnd), 2, 'omitnan'); % events x 1
        Eout = Ein - baselines; % implicit expansion per event
    end

    % -------- 1) pool events from requested emg channels --------
    emgPool   = []; % events x time
    pyrCxPool = []; % events x neurons x time
    intCxPool = [];
    pyrStrPool= [];
    intStrPool= [];

    for ch = channelsToUse
        % emg windows for the triggering muscle (dim-2 = ch)
        emgChunk = squeeze(S.emgWindowsCell{ch}(:, ch, :)); % events x time
        emgPool  = cat(1, emgPool, emgChunk);

        % neural windows
        pyrCxPool  = cat(1, pyrCxPool , S.pyrCxWinCell{ch});  % events x neurons x time
        intCxPool  = cat(1, intCxPool , S.intCxWinCell{ch});
        pyrStrPool = cat(1, pyrStrPool, S.pyrStrWinCell{ch});
        intStrPool = cat(1, intStrPool, S.intStrWinCell{ch});
    end

    % -------- 2) unshifted neural: avg across neurons -> per-trial baseline -> mean/sem --------
    % average across neurons -> events x time
    pyrCx_evt  = meanEvt(pyrCxPool);
    intCx_evt  = meanEvt(intCxPool);
    pyrStr_evt = meanEvt(pyrStrPool);
    intStr_evt = meanEvt(intStrPool);

    % per-trial baseline subtraction before averaging across trials
    if doBaselineNorm
        pyrCx_evt  = subtractTrialBaseline(pyrCx_evt , tAxisFull, -500, -450);
        intCx_evt  = subtractTrialBaseline(intCx_evt , tAxisFull, -500, -450);
        pyrStr_evt = subtractTrialBaseline(pyrStr_evt,  tAxisFull, -500, -450);
        intStr_evt = subtractTrialBaseline(intStr_evt,  tAxisFull, -500, -450);
    end

    % compute mean ± sem across events
    [mPyrCx , sePyrCx ] = grandMS(pyrCx_evt);
    [mIntCx , seIntCx ] = grandMS(intCx_evt);
    [mPyrStr, sePyrStr] = grandMS(pyrStr_evt);
    [mIntStr, seIntStr] = grandMS(intStr_evt);

    % -------- 3) shifted controls: per-trial baseline first, then average to 1xtime per shift --------
    % build matrix where each row is one shift's 1 x time mean (after per-trial baseline subtraction)
    function allShiftsMat = buildShiftMat(firstShiftCell, meanShiftCell, tAxisLocal)
        % output: (#channels*100) x time (100 shifts per channel)
        allShiftsMat = [];
        for ch = channelsToUse
            % first shift (fully saved): events x neurons x time -> events x time
            E_first = meanEvt(firstShiftCell{ch});     % events x time
            if doBaselineNorm
                E_first = subtractTrialBaseline(E_first, tAxisLocal, -500, -450);
            end
            row_first = mean(E_first, 1, 'omitnan');   % 1 x time

            % remaining 99 shifts: each is events x time (already neuron-averaged when saved)
            numStored = numel(meanShiftCell(ch, :));   % expected 99
            rowList = zeros(numStored, numel(tAxisLocal));
            for k = 1:numStored
                E = meanShiftCell{ch, k};              % events x time
                if doBaselineNorm
                    E = subtractTrialBaseline(E, tAxisLocal, -500, -450);
                end
                rowList(k, :) = mean(E, 1, 'omitnan'); % 1 x time
            end

            % stack 100 x time for this channel then accumulate
            chanMat = [row_first; rowList];            % 100 x time
            allShiftsMat = cat(1, allShiftsMat, chanMat);
        end
    end

    pyrCx_shiftMat  = buildShiftMat(S.pyrCxWinShiftedCell , S.pyrCxWinShiftedMeanCell , tAxisFull);
    intCx_shiftMat  = buildShiftMat(S.intCxWinShiftedCell , S.intCxWinShiftedMeanCell , tAxisFull);
    pyrStr_shiftMat = buildShiftMat(S.pyrStrWinShiftedCell, S.pyrStrWinShiftedMeanCell, tAxisFull);
    intStr_shiftMat = buildShiftMat(S.intStrWinShiftedCell, S.intStrWinShiftedMeanCell, tAxisFull);

    % compute shifted-control 2.5 & 97.5 percentiles across shifts
    % each result is 2 x time: [2.5%; 97.5%]
    pyrCx_pct  = prctile(pyrCx_shiftMat , [2.5 97.5], 1);
    intCx_pct  = prctile(intCx_shiftMat , [2.5 97.5], 1);
    pyrStr_pct = prctile(pyrStr_shiftMat, [2.5 97.5], 1);
    intStr_pct = prctile(intStr_shiftMat, [2.5 97.5], 1);

    % -------- 4) emg mean & sem (unchanged; not plotted here) --------
    mEMG  = mean(emgPool , 1 , 'omitnan'); %#ok<NASGU>
    seEMG = std (emgPool , 0 , 1 , 'omitnan') ./ sqrt(size(emgPool,1)); %#ok<NASGU>

    % -------- 5) plot full window -500 to 500 ms --------
    tMask     = (tAxisFull >= -500) & (tAxisFull <= 500);
    tAxisPlot = tAxisFull(tMask);

    mPyrCx_plot   = mPyrCx(tMask);
    sePyrCx_plot  = sePyrCx(tMask);
    mIntCx_plot   = mIntCx(tMask);
    seIntCx_plot  = seIntCx(tMask);
    mPyrStr_plot  = mPyrStr(tMask);
    sePyrStr_plot = sePyrStr(tMask);
    mIntStr_plot  = mIntStr(tMask);
    seIntStr_plot = seIntStr(tMask);

    pyrCx_pct_plot  = pyrCx_pct(:,  tMask);
    intCx_pct_plot  = intCx_pct(:,  tMask);
    pyrStr_pct_plot = pyrStr_pct(:, tMask);
    intStr_pct_plot = intStr_pct(:, tMask);

    % -------- 6) plot (2 x 2) with yyaxis and shifted percentile bounds --------
    figure('Name','unshifted neural (baseline-subtracted) + 95% shifted percentile bounds', ...
           'Color','w');
    tiledlayout(2, 2, 'TileSpacing', 'tight', 'Padding', 'compact');

    % cortex neural
    nexttile(1); hold on;
    yyaxis left
    shadedErrorBar(tAxisPlot, mPyrCx_plot, sePyrCx_plot, ...
        'lineProps', {'b', 'LineWidth', 1.5});
    plot(tAxisPlot, pyrCx_pct_plot(1,:), 'b--');   % 2.5th percentile
    plot(tAxisPlot, pyrCx_pct_plot(2,:), 'b--');   % 97.5th percentile
    ylabel('pyramidal');

    yyaxis right
    shadedErrorBar(tAxisPlot, mIntCx_plot, seIntCx_plot, ...
        'lineProps', {'r', 'LineWidth', 1.5});
    plot(tAxisPlot, intCx_pct_plot(1,:), 'r--');   % 2.5th percentile
    plot(tAxisPlot, intCx_pct_plot(2,:), 'r--');   % 97.5th percentile
    ylabel('interneuron');
    title('cortex neural');
    xlabel('time (ms)');
    xlim([-500 500]);

    % striatum neural
    nexttile(2); hold on;
    yyaxis left
    shadedErrorBar(tAxisPlot, mPyrStr_plot, sePyrStr_plot, ...
        'lineProps', {'b', 'LineWidth', 1.5});
    plot(tAxisPlot, pyrStr_pct_plot(1,:), 'b--');  % 2.5th percentile
    plot(tAxisPlot, pyrStr_pct_plot(2,:), 'b--');  % 97.5th percentile
    ylabel('pyramidal');

    yyaxis right
    shadedErrorBar(tAxisPlot, mIntStr_plot, seIntStr_plot, ...
        'lineProps', {'r', 'LineWidth', 1.5});
    plot(tAxisPlot, intStr_pct_plot(1,:), 'r--');  % 2.5th percentile
    plot(tAxisPlot, intStr_pct_plot(2,:), 'r--');  % 97.5th percentile
    ylabel('interneuron');
    title('striatum neural');
    xlabel('time (ms)');
    xlim([-500 500]);

    sgtitle(sprintf('unshifted neural%s + 95%% shifted percentile bounds', ...
        tern(doBaselineNorm,' (baseline-subtracted)','')));

end

% helper for title string lol
function out = tern(cond, a, b)
    if cond, out = a; else, out = b; end
end
