% gather permutation xcorr results across animals for per-musc chunk script
% each animal & channel:
%   permXC{animal, ch} = nPerm x nLags (each row = one permutation)
%   permPeakLagSec{animal, ch} = 1 x nPerm
%   unpermXC{animal, ch} = 1 x nLags
%   unpermPeakLag{animal, ch} = scalar
% all three animals saved into one .mat

% base dirs for animals (same as in quest scripts)
baseDirs = {
    '/home/asa7288/Transfer/D026', ...
    '/home/asa7288/Transfer/D020', ...
    '/home/asa7288/Transfer/D024' ...
};

nPerm = 100;
channels = 1:4;        % muscles 1–4
nAnimals = numel(baseDirs);
nChannels = numel(channels);

% holders for all animals × channels
allPermXC = cell(nAnimals, nChannels);  % each: nPerm x nLags
allPermPeakLagSec = cell(nAnimals, nChannels);  % each: 1 x nPerm
allLags = cell(nAnimals, nChannels);  % each: 1 x nLags
allBinSize = cell(nAnimals, nChannels);  % each: scalar

allUnpermXC       = cell(nAnimals, nChannels);  % each: 1 x nLags
allUnpermPeakLag  = cell(nAnimals, nChannels);  % each: scalar

for iDir = 1:nAnimals
    baseDir = baseDirs{iDir};
    outDir  = fullfile(baseDir, 'quest_runs');
    fprintf('\nprocessing per-muscle perms for animal %d: %s\n', iDir, baseDir);

    for ci = 1:nChannels
        ch = channels(ci);
        fprintf('  channel %d\n', ch);

        % ----- unpermuted file -----
        unpermFile = fullfile(outDir, ...
            sprintf('concatCrossCorrPerMuscle_unperm_ch%02d.mat', ch));
        if ~exist(unpermFile, 'file')
            warning('  missing unperm file: %s', unpermFile);
            allUnpermXC{iDir, ci} = [];
            allUnpermPeakLag{iDir, ci} = NaN;
        else
            U = load(unpermFile, 'xc', 'peakLagSec', 'lags', 'binSize');
            allUnpermXC{iDir, ci}      = U.xc(:)';      % 1 x nLags
            allUnpermPeakLag{iDir, ci} = U.peakLagSec;  % scalar
        end

        % ----- first permutation to get sizes -----
        firstFile = fullfile(outDir, ...
            sprintf('concatCrossCorrPerMuscle_perm_%03d_ch%02d.mat', 1, ch));
        if ~exist(firstFile, 'file')
            warning('  missing first perm file for ch %d: %s (skipping channel)', ch, firstFile);
            allPermXC{iDir, ci} = [];
            allPermPeakLagSec{iDir, ci} = [];
            allLags{iDir, ci} = [];
            allBinSize{iDir, ci} = [];
            continue;
        end

        tmp = load(firstFile, 'xc', 'lags', 'binSize', 'peakLagSec');
        nLags = numel(tmp.xc);

        permXC = nan(nPerm, nLags);
        permPeakLagSec = nan(1, nPerm);

        % store first perm
        permXC(1, :) = tmp.xc(:)';   % row
        permPeakLagSec(1) = tmp.peakLagSec;
        lags = tmp.lags(:)'; % store once per animal × channel
        binSize = tmp.binSize;

        % remaining permutations
        for p = 2:nPerm
            fname = fullfile(outDir, ...
                sprintf('concatCrossCorrPerMuscle_perm_%03d_ch%02d.mat', p, ch));
            if ~exist(fname, 'file')
                warning('missing perm file: %s (skipping)', fname);
                continue;
            end
            S = load(fname, 'xc', 'lags', 'peakLagSec');

            % optional check: lags consistency
            if numel(S.lags) ~= nLags || any(S.lags(:) ~= lags(:))
                warning('lags mismatch in %s; skipping this permutation.', fname);
                continue;
            end

            permXC(p, :) = S.xc(:)'; % row
            permPeakLagSec(p) = S.peakLagSec;
        end

        % store
        allPermXC{iDir, ci} = permXC;
        allPermPeakLagSec{iDir, ci} = permPeakLagSec;
        allLags{iDir, ci} = lags;
        allBinSize{iDir, ci} = binSize;
    end
end

% save everything into one mat file
outFileAll = '/home/asa7288/Transfer/allAnimals_concatCrossCorrPerMuscle_perms.mat';
save(outFileAll, ...
     'allPermXC', 'allPermPeakLagSec', ...
     'allUnpermXC', 'allUnpermPeakLag', ...
     'allLags', 'allBinSize', 'baseDirs', 'channels', 'nPerm');

fprintf('\nsaved per-muscle perms + unperm to: %s\n', outFileAll);
